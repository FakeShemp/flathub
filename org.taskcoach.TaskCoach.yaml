app-id: org.taskcoach.TaskCoach
runtime: org.gnome.Platform
runtime-version: '3.36'
sdk: org.gnome.Sdk
command: taskcoach
finish-args:
  - --share=ipc
  - --socket=x11
  - --share=network
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=xdg-documents
  - --filesystem=xdg-run/dconf
  - --filesystem=~/.config/dconf:ro
  - --talk-name=ca.desrt.dconf
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf
cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/*.la
  - /lib/*/*.la
  - /lib/*.a
  - /lib/*/*.a
  - /share/gtk-doc
  - /share/man
  - /share/locale
  - /share/runtime
  - /share/aclocal
modules:
  - shared-modules/python2.7/python-2.7.json

  - name: wxpython
    buildsystem: simple
    subdir: wxPython
    build-options:
      env:
        ACLOCAL_PATH: build/aclocal/
    build-commands:
      - >-
        ../configure
        --prefix=${FLATPAK_DEST}
        --with-gtk=3
        --with-opengl
        --enable-unicode
        --enable-graphics_ctx
        --disable-precomp-headers
        --with-regex=sys
        --with-libpng=sys
        --with-libxpm=sys
        --with-libjpeg=sys
        --with-libtiff=sys
        --with-wx-config=/app/bin/wx-config
        --libdir=/app/lib
        --includedir=/app/include 
      - python2 setup.py WX_CONFIG=/app/bin/wx-config WXPORT=gtk3 UNICODE=1 install --prefix="${FLATPAK_DEST}" --optimize=1
    modules:
      - shared-modules/glu/glu-9.json
      - shared-modules/SDL/SDL-1.2.15.json

      - name: gstreamer
        config-opts:
          - --enable-shared
          - --disable-gtk-doc
        sources:
          - type: archive
            url: https://gstreamer.freedesktop.org/src/gstreamer/gstreamer-0.10.36.tar.xz
            sha256: 9151aa108c177054387885763fa0e433e76780f7c5655c70a5390f2a6c6871da
          - type: patch
            path: patches/bison3.patch
          - type: patch
            path: patches/tests-remove-silly-test_fail_abstract_new-check.patch
          - type: shell
            commands:
              - cp -p /usr/share/automake-*/config.{sub,guess} .
              - autoreconf -vfi
        cleanup:
          - /bin

      - name: gstreamer-base-plugins
        config-opts:
          - --disable-static
          - --disable-gtk-doc
        sources:
          - type: archive
            url: https://gstreamer.freedesktop.org/src/gst-plugins-base/gst-plugins-base-0.10.36.tar.xz
            md5: 3d2337841b132fe996e5eb2396ac9438
          - type: shell
            only-arches:
              - 'i386'
            commands:
              - sed -i 's+#define _USE_SSE+//#define _USE_SSE+g' gst/audioresample/speex_resampler_float.c
              - sed -i 's+#define _USE_SSE2+//#define _USE_SSE2+g' gst/audioresample/speex_resampler_float.c
              - sed -i 's+#define _USE_SSE2+//#define _USE_SSE2+g' gst/audioresample/speex_resampler_double.c
          - type: shell
            commands:
              - cp -p /usr/share/automake-*/config.{sub,guess} .
              - autoreconf -vfi
              - sed -i -e '/AC_PATH_XTRA/d' -e 's/AM_CONFIG_HEADER/AC_CONFIG_HEADERS/' configure.ac
          - type: patch
            path: patches/fix-crash-0-byte-ogg.patch
          - type: patch
            path: patches/colorbalance-fix-abi.patch
          - type: patch
            path: patches/ayuv64-lanczos.patch
          - type: patch
            path: patches/videoscale-fix-negotiation.patch
          - type: patch
            path: patches/gstaudio-symbols.patch
        cleanup:
          - /share
          - /bin

      - name: wxgtk3
        config-opts:
          - --prefix=${FLATPAK_DEST}
          - --with-gtk=3
          - --with-opengl
          - --enable-unicode
          - --enable-graphics_ctx
          - --enable-mediactrl
          - --with-regex=builtin
          - --with-libpng=sys 
          - --with-libxpm=sys 
          - --with-libjpeg=sys 
          - --with-libtiff=sys
          - --disable-precomp-headers
        sources:
          - type: archive
            url: https://github.com/wxWidgets/wxWidgets/releases/download/v3.0.4/wxWidgets-3.0.4.tar.bz2
            sha256: 96157f988d261b7368e5340afa1a0cad943768f35929c22841f62c25b17bf7f0
          - type: patch
            path: patches/make-abicheck-non-fatal.patch
    sources:
      - type: archive
        url: http://download.sourceforge.net/wxpython/wxPython-src-3.0.2.0.tar.bz2
        sha256: d54129e5fbea4fb8091c87b2980760b72c22a386cb3b9dd2eebc928ef5e8df61
      - type: patch
        path: patches/fix-plot.patch
      - type: shell
        commands:
          - find . -type f -exec sed -i 's/env python/env python2/' {} \;
    cleanup:
      - /lib/wx
      - /share/bakefile

  - name: twisted
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - python2 setup.py install --prefix="${FLATPAK_DEST}" --optimize=1
    modules:
      - name: incremental
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" incremental-17.5.0-py2.py3-none-any.whl
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/f5/1d/c98a587dc06e107115cf4a58b49de20b19222c83d75335a192052af4c4b7/incremental-17.5.0-py2.py3-none-any.whl
            sha256: 717e12246dddf231a349175f48d74d93e2897244939173b01974ab6661406b9f

      - name: attrs
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" attrs-19.1.0-py2.py3-none-any.whl
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/23/96/d828354fa2dbdf216eaa7b7de0db692f12c234f7ef888cc14980ef40d1d2/attrs-19.1.0-py2.py3-none-any.whl
            sha256: 69c0dbf2ed392de1cb5ec704444b08a5ef81680a61cb899dc08127123af36a79

      - name: pyhamcrest
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" PyHamcrest-1.9.0-py2.py3-none-any.whl
        modules:
          - name: six
            buildsystem: simple
            build-commands:
              - pip2 install --prefix="${FLATPAK_DEST}" six-1.12.0-py2.py3-none-any.whl
            sources:
              - type: file
                url: https://files.pythonhosted.org/packages/73/fb/00a976f728d0d1fecfe898238ce23f502a721c0ac0ecfedb80e0d88c64e9/six-1.12.0-py2.py3-none-any.whl
                sha256: 3350809f0555b11f552448330d0b52d5f24c91a322ea4a15ef22629740f3761c
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/9a/d5/d37fd731b7d0e91afcc84577edeccf4638b4f9b82f5ffe2f8b62e2ddc609/PyHamcrest-1.9.0-py2.py3-none-any.whl
            sha256: 6b672c02fdf7470df9674ab82263841ce8333fb143f32f021f6cb26f0e512420

      - name: hyperlink
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" hyperlink-19.0.0-py2.py3-none-any.whl
        modules:
          - name: idna
            buildsystem: simple
            build-commands:
              - pip2 install --prefix="${FLATPAK_DEST}" idna-2.8-py2.py3-none-any.whl
            sources:
              - type: file
                url: https://files.pythonhosted.org/packages/14/2c/cd551d81dbe15200be1cf41cd03869a46fe7226e7450af7a6545bfc474c9/idna-2.8-py2.py3-none-any.whl
                sha256: ea8b7f6188e6fa117537c3df7da9fc686d485087abf6ac197f9c46432f7e4a3c
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/7f/91/e916ca10a2de1cb7101a9b24da546fb90ee14629e23160086cf3361c4fb8/hyperlink-19.0.0-py2.py3-none-any.whl
            sha256: ab4a308feb039b04f855a020a6eda3b18ca5a68e6d8f8c899cbe9e653721d04f

      - name: automat
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" Automat-0.7.0-py2.py3-none-any.whl
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/a3/86/14c16bb98a5a3542ed8fed5d74fb064a902de3bdd98d6584b34553353c45/Automat-0.7.0-py2.py3-none-any.whl
            sha256: fdccab66b68498af9ecfa1fa43693abe546014dd25cf28543cbe9d1334916a58

      - name: constantly
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" constantly-15.1.0-py2.py3-none-any.whl
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/b9/65/48c1909d0c0aeae6c10213340ce682db01b48ea900a7d9fce7a7910ff318/constantly-15.1.0-py2.py3-none-any.whl
            sha256: dd2fa9d6b1a51a83f0d7dd76293d734046aa176e384bf6e33b7e44880eb37c5d

      - name: zope.interface
        buildsystem: simple
        build-commands:
          - python2 setup.py install --prefix="${FLATPAK_DEST}" --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/4e/d0/c9d16bd5b38de44a20c6dc5d5ed80a49626fafcb3db9f9efdc2a19026db6/zope.interface-4.6.0.tar.gz
            sha256: 1b3d0dcabc7c90b470e59e38a9acaa361be43b3a6ea644c0063951964717f0e5
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/79/59/035de19362320e632301ed7bbde23e4c8cd6fc5e2f1cf8d354cdba857854/Twisted-19.2.1.tar.bz2
        sha256: fa2c04c2d68a9be7fc3975ba4947f653a57a656776f24be58ff0fe4b9aaf3e52

  - name: taskcoach
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix="${FLATPAK_DEST}" --optimize=1
      - install -Dm755 taskcoach.sh "${FLATPAK_DEST}/bin/taskcoach"
    post-install:
      - install -Dm644 appdata.xml "${FLATPAK_DEST}/share/appdata/${FLATPAK_ID}.appdata.xml"
      - install -Dm644 build.in/linux_common/taskcoach.desktop "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - install -Dm644 icon.svg "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg"
      - icon_in=icon.svg;
        icon_out="${FLATPAK_ID}.png";
        for s in {32,64,128,256,512}; do
        rsvg-convert "${icon_in}" -w "${s}" -h "${s}" -a -f png -o "${icon_out}";
        install -p -Dm644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
        done;
      - desktop-file-edit --set-key=Exec --set-value="taskcoach %f" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - desktop-file-edit --set-icon="${FLATPAK_ID}" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/taskcoach/TaskCoach-1.4.6.tar.gz
        md5: 8f6a2f703740b7f533c00120baacefd6
      - type: script
        dest-filename: taskcoach.sh
        commands:
          - python2 /app/bin/taskcoach.py "$@"
      - type: file
        path: patches/Nuvola_apps_korganizer.svg
        dest-filename: icon.svg
      - type: file
        path: patches/taskcoach.appdata.xml
        dest-filename: appdata.xml
