app-id: org.taskcoach.TaskCoach
runtime: org.gnome.Platform
runtime-version: '3.30'
sdk: org.gnome.Sdk
required-flatpak: '1.0'
command: taskcoach
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --share=network
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=xdg-documents
cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/*.la
  - /lib/*/*.la
  - /lib/*.a
  - /lib/*/*.a
  - /share/gtk-doc
  - /share/man
  - /share/locale
  - /share/runtime
  - /share/aclocal
modules:
  - shared-modules/python2.7/python-2.7.15.json

  - name: wxPython
    buildsystem: simple
    subdir: wxPython
    build-options:
      env:
        ACLOCAL_PATH: build/aclocal/
    build-commands:
      - python2 build-wxpython.py --install --gtk3 --prefix="${FLATPAK_DEST}"
    modules:
      - shared-modules/glu/glu-9.0.0.json
      - shared-modules/SDL/SDL-1.2.15.json

      - name: GStreamer
        config-opts:
          - --enable-shared
          - --disable-gtk-doc
        sources:
          - type: archive
            url: https://gstreamer.freedesktop.org/src/gstreamer/gstreamer-0.10.36.tar.xz
            sha256: 9151aa108c177054387885763fa0e433e76780f7c5655c70a5390f2a6c6871da
          - type: patch
            path: patches/bison3.patch
          - type: patch
            path: patches/tests-remove-silly-test_fail_abstract_new-check.patch
          - type: shell
            commands:
              - cp -p /usr/share/automake-*/config.{sub,guess} .
              - autoreconf -vfi
        cleanup:
          - /bin

      - name: GStreamer-Base-Plugins
        config-opts:
          - --disable-static
          - --disable-gtk-doc
        sources:
          - type: archive
            url: https://gstreamer.freedesktop.org/src/gst-plugins-base/gst-plugins-base-0.10.36.tar.xz
            md5: 3d2337841b132fe996e5eb2396ac9438
          - type: shell
            only-arches:
              - 'i386'
            commands:
              - sed -i 's+#define _USE_SSE+//#define _USE_SSE+g' gst/audioresample/speex_resampler_float.c
              - sed -i 's+#define _USE_SSE2+//#define _USE_SSE2+g' gst/audioresample/speex_resampler_float.c
              - sed -i 's+#define _USE_SSE2+//#define _USE_SSE2+g' gst/audioresample/speex_resampler_double.c
          - type: shell
            commands:
              - cp -p /usr/share/automake-*/config.{sub,guess} .
              - autoreconf -vfi
              - sed -i -e '/AC_PATH_XTRA/d' -e 's/AM_CONFIG_HEADER/AC_CONFIG_HEADERS/' configure.ac
          - type: patch
            path: patches/fix-crash-0-byte-ogg.patch
          - type: patch
            path: patches/colorbalance-fix-abi.patch
          - type: patch
            path: patches/ayuv64-lanczos.patch
          - type: patch
            path: patches/videoscale-fix-negotiation.patch
          - type: patch
            path: patches/gstaudio-symbols.patch
        cleanup:
          - /share
          - /bin
    sources:
      - type: archive
        url: http://download.sourceforge.net/wxpython/wxPython-src-3.0.2.0.tar.bz2
        sha256: d54129e5fbea4fb8091c87b2980760b72c22a386cb3b9dd2eebc928ef5e8df61
      - type: shell
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} .
          - autoreconf -vfi
    cleanup:
      - /lib/wx
      - /share/bakefile

  - name: Twisted
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - python2 setup.py install --prefix="${FLATPAK_DEST}" --optimize=1
    modules:
      - name: incremental
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" incremental-17.5.0-py2.py3-none-any.whl
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/f5/1d/c98a587dc06e107115cf4a58b49de20b19222c83d75335a192052af4c4b7/incremental-17.5.0-py2.py3-none-any.whl
            sha256: 717e12246dddf231a349175f48d74d93e2897244939173b01974ab6661406b9f

      - name: attrs
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" attrs-18.2.0-py2.py3-none-any.whl
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/3a/e1/5f9023cc983f1a628a8c2fd051ad19e76ff7b142a0faf329336f9a62a514/attrs-18.2.0-py2.py3-none-any.whl
            sha256: ca4be454458f9dec299268d472aaa5a11f67a4ff70093396e1ceae9c76cf4bbb

      - name: PyHamcrest
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" PyHamcrest-1.9.0-py2.py3-none-any.whl
        modules:
          - name: six
            buildsystem: simple
            build-commands:
              - pip2 install --prefix="${FLATPAK_DEST}" six-1.12.0-py2.py3-none-any.whl
            sources:
              - type: file
                url: https://files.pythonhosted.org/packages/73/fb/00a976f728d0d1fecfe898238ce23f502a721c0ac0ecfedb80e0d88c64e9/six-1.12.0-py2.py3-none-any.whl
                sha256: 3350809f0555b11f552448330d0b52d5f24c91a322ea4a15ef22629740f3761c
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/9a/d5/d37fd731b7d0e91afcc84577edeccf4638b4f9b82f5ffe2f8b62e2ddc609/PyHamcrest-1.9.0-py2.py3-none-any.whl
            sha256: 6b672c02fdf7470df9674ab82263841ce8333fb143f32f021f6cb26f0e512420

      - name: hyperlink
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" hyperlink-18.0.0-py2.py3-none-any.whl
        modules:
          - name: idna
            buildsystem: simple
            build-commands:
              - pip2 install --prefix="${FLATPAK_DEST}" idna-2.8-py2.py3-none-any.whl
            sources:
              - type: file
                url: https://files.pythonhosted.org/packages/14/2c/cd551d81dbe15200be1cf41cd03869a46fe7226e7450af7a6545bfc474c9/idna-2.8-py2.py3-none-any.whl
                sha256: ea8b7f6188e6fa117537c3df7da9fc686d485087abf6ac197f9c46432f7e4a3c
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/a7/b6/84d0c863ff81e8e7de87cff3bd8fd8f1054c227ce09af1b679a8b17a9274/hyperlink-18.0.0-py2.py3-none-any.whl
            sha256: 98da4218a56b448c7ec7d2655cb339af1f7d751cf541469bb4fc28c4a4245b34

      - name: Automat
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" Automat-0.7.0-py2.py3-none-any.whl
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/a3/86/14c16bb98a5a3542ed8fed5d74fb064a902de3bdd98d6584b34553353c45/Automat-0.7.0-py2.py3-none-any.whl
            sha256: fdccab66b68498af9ecfa1fa43693abe546014dd25cf28543cbe9d1334916a58

      - name: constantly
        buildsystem: simple
        build-commands:
          - pip2 install --prefix="${FLATPAK_DEST}" constantly-15.1.0-py2.py3-none-any.whl
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/b9/65/48c1909d0c0aeae6c10213340ce682db01b48ea900a7d9fce7a7910ff318/constantly-15.1.0-py2.py3-none-any.whl
            sha256: dd2fa9d6b1a51a83f0d7dd76293d734046aa176e384bf6e33b7e44880eb37c5d

      - name: zope.interface
        buildsystem: simple
        build-commands:
          - python2 setup.py install --prefix="${FLATPAK_DEST}" --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/4e/d0/c9d16bd5b38de44a20c6dc5d5ed80a49626fafcb3db9f9efdc2a19026db6/zope.interface-4.6.0.tar.gz
            sha256: 1b3d0dcabc7c90b470e59e38a9acaa361be43b3a6ea644c0063951964717f0e5
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/5d/0e/a72d85a55761c2c3ff1cb968143a2fd5f360220779ed90e0fadf4106d4f2/Twisted-18.9.0.tar.bz2
        sha256: 294be2c6bf84ae776df2fc98e7af7d6537e1c5e60a46d33c3ce2a197677da395

  - name: TaskCoach
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix="${FLATPAK_DEST}" --optimize=1
      - install -Dm755 taskcoach.sh "${FLATPAK_DEST}/bin/taskcoach"
    post-install:
      - install -Dm644 appdata.xml "${FLATPAK_DEST}/share/appdata/${FLATPAK_ID}.appdata.xml"
      - install -Dm644 build.in/linux_common/taskcoach.desktop "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - install -Dm644 icon.svg "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg"
      - icon_in=icon.svg;
        icon_out="${FLATPAK_ID}.png";
        for s in {16,24,32,48,72,96,128,192,256,512}; do
        rsvg-convert "${icon_in}" -w "${s}" -h "${s}" -a -f png -o "${icon_out}";
        install -p -Dm644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
        done;
      - desktop-file-edit --set-key=Exec --set-value="taskcoach %f" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - desktop-file-edit --set-icon="${FLATPAK_ID}" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/taskcoach/TaskCoach-1.4.4.tar.gz
        sha256: a06c2cebadae5e175d7672e28dd10b7a323992b0d1d1f11e830d9f553bb165c9
      - type: script
        dest-filename: taskcoach.sh
        commands:
          - python2 /app/bin/taskcoach.py "$@"
      - type: file
        path: patches/Nuvola_apps_korganizer.svg
        dest-filename: icon.svg
      - type: file
        path: patches/taskcoach.appdata.xml
        dest-filename: appdata.xml
